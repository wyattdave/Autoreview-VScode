const sExceptLink="concat('https://make.powerautomate.com/manage/environments/', workflow()?['tags']?['environmentName']",sExceptLink2="concat('https://make.powerautomate.com/manage/environments/',workflow()?['tags']?['environmentName']",regExFlow=RegExp("/flows/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}"),regExEnvir=RegExp("/environments/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}"),regExEnvirD=RegExp("/environments/Default-[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}"),regExpEnviron=RegExp("@parameters(.*?)\\)","gm"),regExpEnviron2=RegExp("@{parameters(.*?)\\)","gm");function CreateReview(e,t,n,i,r,a,o,s){let l=[],p=[],c=[],u=[],m=[],f=[],g="unknown",d="none",h="none",y="none",$="none",v="none",x="none";console.log(t,n,i,r,a,o,s),(""==o||void 0==o)&&(o="please input");let b=JSON.parse(e),E=Object.keys(b.properties.definition.triggers),w=getChildren(b.properties.definition,[],0,"root");b.properties?.displayName!=void 0?(t=b.properties.displayName,n=b.name):void 0!=b.name&&(n=b.name),E.forEach(e=>{let t=b.properties.definition.triggers[e];g=e,t?.inputs?.schema!=null&&(d=JSON.stringify(t.inputs)),t?.inputs?.parameters!=null&&(d=JSON.stringify(t.inputs)),t?.inputs?.parameters!=null&&(h=JSON.stringify(t.inputs.parameters)),t?.recurrance!=null&&(x=t.recurrance),t?.conditions!=null&&t.conditions[0]?.expression!=null&&($=t.conditions[0].expression),t?.inputs?.schema?.properties!=null&&(v=JSON.stringify(t.inputs.schema.properties)),t?.runtimeConfiguration!=null&&(y=JSON.stringify(t.runtimeConfiguration))}),w.forEach((e,t)=>{let n="MISSING";e.metadata?.operationMetadataId!=null&&(n=e.metadata.operationMetadataId);let r="",o="",s="";"OpenApiConnection"==e.type?(r=e.inputs.host.operationId,o=e.inputs.host.connectionName,s=e.inputs.host.apiId):r=e.type;let p="Standard",c=null;if(""!=o){let u=a.find(e=>e.name.includes(o.substring(0,o.length-2).trim()));"shared_sendmail"==o||"shared_teams"==o?p="Standard":void 0!=u?(p=u.properties.tier,c=u.properties.iconUri):p="Premium"}let m="",g="|",d="Non-Exception";"{}"==JSON.stringify(e.runAfter)||void 0==e.runAfter||null==e.runAfter?m=e.parent+":Success":Object.keys(e.runAfter).forEach(t=>{g+=t+"|",m=t+":"+JSON.stringify(e.runAfter[t]).replaceAll(","," | "),JSON.stringify(e.runAfter[t]).includes("Failed")&&(d="Exception")}),"|"==g&&0==e.nestedLevel&&(g="|trigger|"),"|"==g&&0!=e.nestedLevel&&(g="|"+e.parent+"|"),m.length>1&&(m=m.substring(0,m.length-1));let h,y=i.find(t=>t.Name.includes(r+o)||t.Name==e.type);h=null!=y?Number(y.Complexity):1;let $="";e?.inputs?.parameters?.$filter!=null&&($=e.inputs.parameters.$filter);let v="",x="";e?.inputs?.retryPolicy!=null&&(v=e.inputs.retryPolicy.type,x=JSON.stringify(e.inputs.retryPolicy));let b="";e?.runtimeConfiguration?.paginationPolicy!=null&&(b=e.runtimeConfiguration.paginationPolicy.minimumItemCount);let E="";e?.runtimeConfiguration?.secureData!=null&&(E=JSON.stringify(e.runtimeConfiguration.secureData));let w="";e?.limit?.timeout!=null&&(w=e.limit.timeout);let I="";e?.description!=null&&(I=e.description);let N=e;N.hasOwnProperty("actions")&&delete N.actions;let _=JSON.stringify(N).match(regExpEnviron),C,k=!1;_&&(C=_.filter(e=>"@parameters('$authentication')"!=e)).length>0&&(k=!0),!k&&(C=JSON.stringify(N).match(regExpEnviron2))&&(C=C.filter(e=>"@{parameters('$authentication')"!=e)).length>0&&(k=!0);let A="";e.parent==m.split(":")[0]&&(A="Internal");let O="";O=void 0==e.inputs?"":e.inputs.hasOwnProperty("parameters")?JSON.stringify(e.inputs.parameters):JSON.stringify(e.inputs),e.hasOwnProperty("foreach")&&(O=JSON.stringify(e.foreach)),e.hasOwnProperty("expression")&&(O=JSON.stringify(e.expression)),l.push({name:e.operationName,step:r,type:e.type,id:n,hashId:n+"###"+(t+1),tier:p,connector:o,imgURL:c,runAfter:m.replace(/[\[\]""]/g,""),exception:d,index:t+1,object:e,complexity:h,detail:O,filter:$,pagination:b,secure:E,retry:v,timeout:w,position:g,positionInfo:A,environmentVariables:JSON.stringify(C),environmentB:k,notes:I,parent:e.parent,apiId:s,branch:e.branch}),f.push({step:r,connector:o,name:e.operationName,id:n,hashId:n+"###"+(t+1),object:JSON.stringify(e),type:e.type,index:t+1,parent:e.parent})}),l.forEach(e=>{if("|trigger|"==e.position)e.positionIndex="|0",e.positionType="|trigger",e.nested="";else{e.positionIndex="",e.positionType="",e.nested="";l.filter(t=>e.position.includes("|"+t.name+"|")).forEach(t=>{e.positionIndex+="|"+Number(t.index),e.positionType+="|"+t.type;let n=getNesting(e.parent,l)+"";"|0"==n.substring(n.length-2,2)&&(n=n.substring(0,n.length-2)),("0"==n||void 0==n||null==n||"undefined"==n)&&(n=""),e.nested=n})}});let I=l.filter(e=>null!=e.detail&&void 0!=e.detail&&"InitializeVariable"!=e.type);w.filter(e=>"InitializeVariable"==e.type).forEach(e=>{let t="",n=!1,i=!1,a=e.inputs.variables[0],o=I.filter(e=>"string"==typeof e.detail&&e.detail.includes(a.name));r.data.filter(e=>e.Type==a.type).length>0&&(t=r.data.find(e=>e.Type==a.type).Letter),a.name.substring(0,r.char)==t&&(n=!0),""!=a.value&&void 0!=a.value&&null!=a.value?a.name.substring(1,a.name.length-1)===a.name.substring(1,a.name.length-1).toUpperCase()&&(i=!0):i=!0;let s="";s=isObject(a.value)?JSON.stringify(a.value):void 0==a.value?"":a.value+"",void 0==a.value&&(a.value=""),p.push({name:a.name,type:a.type,value:s,used:o.length>0,named:n,local:i})}),getDistinct(l).forEach(e=>{let t=l.find(t=>t.connector==e);c.push({conName:e,appId:t.apiId,opId:t.step,count:l.filter(t=>t.connector==e).length})}),m=l.filter(e=>"OpenApiConnection"==e.type),u=l.filter(e=>"Exception"==e.exception);let N;N=0==p.length||p.every(e=>!0===e.named);let _;_=0==p.length||p.every(e=>!0===e.local);let C;C=0==p.length||p.every(e=>!0===e.used);let k=u.filter(e=>"Exception"==e.name),A=!1,O=!1;return k&&(A=k.length>0&&JSON.stringify(k[0].object).includes("Terminate"),O=k.length>0&&(JSON.stringify(k[0].object).includes("concat('https://make.powerautomate.com/manage/environments/', workflow()?['tags']?['environmentName']")||JSON.stringify(k[0].object).includes("concat('https://make.powerautomate.com/manage/environments/',workflow()?['tags']?['environmentName']"))),l.forEach(e=>{delete e.object,delete e.apiId;let t=l.find(t=>t.name==e.parent);null!=t&&"If"!=t.type&&"Switch"!=t.type&&(e.branch="")}),{name:t,id:n,environment:s,owner:o,trigger:g,triggerData:h,triggerParam:d,triggerConfig:y,triggerExpress:$,triggerInputs:v,triggerRecur:x,premium:!l.every(e=>"Standard"===e.tier),connectionRefs:c.length,connectors:m.length,steps:l.length,variables:p.length,complexity:sumObj(l,"complexity"),varNaming:N,varNameConsts:_,varNameUse:C,composes:l.filter(e=>"Compose"==e.type).length,exception:u.length,exceptionHandleScope:u.filter(e=>"Scope"==e.step).length>0,exceptionScope:k.length>0,exceptionTerminate:A,exceptionLink:O,mainScope:l.filter(e=>"Main"==e.name).length>0,variableArray:p,actionArray:l,apiActionArray:m,exceptionArray:u,connectionArray:c,error:"",actionObjectArray:f}}function getNesting(e,t){let n;if("root"!=e){let i=t.find(t=>t.name==e);n=i.index,"root"!=i.parent&&(n+="|"+getNesting(i.parent,t))}return n}function getChildren(e,t,n,i){if(e?.actions!=void 0&&Object.keys(e.actions).forEach(r=>{let a=e.actions[r];a.operationName=r,a.nestedLevel=n,a.parent=i,a.branch="Yes",t.push(a),t=getChildren(a,t,n+1,r)}),e?.else!=void 0&&Object.keys(e.else.actions).forEach(r=>{let a=e.else.actions[r];a.operationName=r,a.nestedLevel=n,a.parent=i,a.branch="No",t.push(a),t=getChildren(a,t,n+1,r)}),e?.cases!=void 0){Object.keys(e.cases).forEach(r=>{Object.keys(e.cases[r].actions).forEach(a=>{let o=e.cases[r].actions[a];o.operationName=a,o.nestedLevel=n,o.parent=i,o.branch=r,t.push(o),t=getChildren(o,t,n+1,a)})});Object.keys(e.default.actions).forEach(r=>{let a=e.default.actions[r];a.operationName=r,a.nestedLevel=n,a.parent=i,a.branch="Default",t.push(a),t=getChildren(a,t,n+1,a)})}return t}function sumObj(e=[],t){return e.reduce((e,n)=>e+n[t],0)}function getParent(e){return e.sort((e,t)=>e.value-t.value)[0]}function getDistinct(e){let t=new Set;for(let n of e)""!=n.connector&&t.add(n.connector);return Array.from(t)}function isObject(e){return e&&"object"==typeof e&&e.constructor===Object}function removeItemById(e,t){return e.filter(e=>e.flow!==t)}function distanceBetween(e,t,n){return Math.abs(e.indexOf(t)-e.indexOf(n))}module.exports={CreateReview};